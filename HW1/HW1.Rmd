---
title: "111208094_hw1"
output: pdf_document
encoding: UTF-8
---
```{r}
options(repos = c(CRAN = "https://cran.rstudio.com/"))
install.packages("tinytex")
tinytex::install_tinytex(force = TRUE)
```

1.  請讀入資料：stock = read_csv(“stock.csv”) 資料為2023/12/1\~2024/3/7，5個股票的股價，變數為：id_name：每檔股票的證券代碼與名稱，如：2330台積電，表示證券代碼2330，公司名稱為台積電。type：open 代表開盤價，close 代表收盤價。 2023/12/1：為該天交易價格（剩下日期變數依此類推）。 請用tidyr提到的gather,spread,sperate等函數指令，將資料整理成下方「tidy」格式

```{r}
#By myself (我寫好爛好長)
install.packages("readr")
library(readr)
library(tidyr)
stock_short <- read_csv("C:\\Users\\Ava\\Desktop\\R\\HW1\\stock.csv")
stock_short1 <-separate(stock_short,id_name,into = c("id","name"),sep = " ")
stock_short2 <- gather(stock_short1,key = "time" ,value = "value", -id,-name,-type)
stock_short3 <-separate(stock_short2,time,into = c("year","month","date"),sep = "/")
stock_long <- pivot_wider(stock_short3, names_from = type, values_from = value) 
print(stock_long) #answer
```

2.  電商公司，有三個資料集合：

sales.df：產品銷售狀況 （“salesID”銷售紀錄編號，“Store”店家編號， “Product”產品編號，“Client”顧客編號，“UnitPrice”單價，“Quantity”購買數量，“Region”顧客國家 ）

client.df：顧客的個人資料 (“Client”顧客編號，“Age”年紀，“Membership”會員等級， “Gender”性別 )

prod.df：產品的相關資料（“Item” 代號＿產品） 請用tidyverse套件裡學到的方法，分析

(1.) prod.df 裡將兩個變數，誤紀錄為在同一個column，其將其分開為兩個變數Product（數字部分）及Item（商品部分），取代原prod.df。 
(2.) 將3個報表合併為full.table 
(3.) 在full.table. 新增一個變數「總消費」為spend = UnitPrice\*Quantity 
(4.) 在full.table將會員等級分組，其中gold和diamond的顧客為一組，其他等級的為一組，針對兩組客戶進行比較介紹（例如平均年紀、性別、國家、消費情況差異等）。 
(5.) 在full.table針對女性客戶進行分析（例如平均年紀、國家、消費情況等），並對他們在不同產品的「總消費」畫圖分析。

```{r cars}
#資料匯入
client_list <- read_csv("C:\\Users\\Ava\\Desktop\\R\\HW1\\client_list.csv")
salesdata <- read_csv("C:\\Users\\Ava\\Desktop\\R\\HW1\\salesdata.csv")
product_list <- read_csv("C:\\Users\\Ava\\Desktop\\R\\HW1\\product_list.csv")
#(1.)
product_list1 <- separate(product_list,Item,into = c("Product","Item"),sep = "_",,convert=TRUE)
product_list1
```

```{r pressure, echo=FALSE}
#(2.)
library(dplyr)
salesdata_sorted <- salesdata %>% arrange(Client)
salesdata_sorted  %>% left_join(client_list,by="Client") -> merge1
merge1  %>% left_join(product_list1,by="Product") -> full_table
full_table
```

```{r}
#(3.)
library(tidyverse)
full_table%>%
  mutate( Spend = UnitPrice*Quantity ) -> full_table1
library(writexl)
write_xlsx(full_table1, path = "C:/Users/Ava/Downloads/full_table1.xlsx") #保存下來方便之後跑EDA!!
full_table1
```

```{r}
#(4.) EDA Start!!!
#分組
full_table2 <- full_table1 %>%
  mutate(Group = ifelse(Membership %in% c("gold", "diamond"), "Gold & Diamond", "Other"))
full_table2
#年紀
age_comparison <- full_table2 %>%
  group_by(Group) %>%
  summarise(Average_Age = mean(Age, na.rm = TRUE))
age_comparison
#性別
gender_comparison <- full_table2 %>%
  group_by(Group, Gender) %>%
  summarise(Count = n()) %>%
  mutate(Percentage = Count / sum(Count) * 100)
gender_comparison
#國家
country_comparison <- full_table2 %>%
  group_by(Group, Region) %>%
  summarise(Count = n()) %>%
  arrange(Group, desc(Count))
country_comparison
#消費差異
spend_comparison <- full_table2 %>%
  group_by(Group) %>%
  summarise(Average_Spend = mean(Spend, na.rm = TRUE),
            Total_Spend = sum(Spend, na.rm = TRUE),
            Std_Dev_Spend = sd(Spend, na.rm = TRUE))
```

```{r}
#(5.)
full_table2_female <- full_table2[full_table2$Gender =="female",]
write_xlsx(full_table2_female, path = "C:/Users/Ava/Downloads/full_table2_female.xlsx")

#年紀
age_comparison_female <- full_table2_female %>%
  summarise(Average_Age = mean(Age, na.rm = TRUE))

pie(table(full_table2_female$Age))

#國家
country_comparison_female <- full_table2_female %>%
  group_by(Region) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count))

pie(table(full_table2_female$Region)) 

#消費差異
spend_comparison_female <- full_table2_female %>%
  summarise(Average_Spend = mean(Spend, na.rm = TRUE),
            Total_Spend = sum(Spend, na.rm = TRUE),
            Std_Dev_Spend = sd(Spend, na.rm = TRUE))

#不同產品的「總消費」畫圖分析
library(ggplot2)
p <- ggplot(full_table2_female, aes(x = Spend , fill = Item)) + geom_density(alpha = 0.7)
plot(p, labels = "AUTO")
plot
```
